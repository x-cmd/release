
(
inner(){
    git branch -r | awk '{
        gsub("^[^/]+/", "", $1)
        print $1
    }' | awk '$1~/^v/{
        print $1
    }'
}

buildone(){
    local version=${1:?Provide version}

    # version
    git checkout "$version" || return 1

    local hashsum; hashsum="$(cat version_sum)" || {
        x:info "Cannot found version_sum. Exit: $hashsum"
        return 0
    }

    hashsum="${hashsum#*=}"

    [ -f "${RELEASE_HASH}/${hashsum}.tgz" ] || {
        x z "${RELEASE_HASH}/${hashsum}.tgz" mod mod.index.txt mod.sha512.txt reference.txt version_sum X LICENSE license_of_components
    }

    x cp "${RELEASE_HASH}/${hashsum}.tgz" "${RELEASE_DIST}/${version}.tgz"

    git checkout latest
}

RELEASE_HASH="$(x wsroot)/hash"
RELEASE_DIST="$(x wsroot)/dist"

build(){
    {
        printf "%s\n" latest
        inner
    } | while read -r v; do
        buildone "$v"
    done
}

xws cdb build
)

